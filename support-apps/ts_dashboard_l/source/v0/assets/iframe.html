<html>

<head>
  <!-- Zendesk Garden styles are provided for apps from this URL. We recommend hotlinking to this version
       provided by our CDN to ensure the latest updates are refected in your app. -->
  <link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/1/zendesk_garden.css" type="text/css">
</head>

<body>
  <!-- Spacing utility classes are used throughout this file to provide margin and padding between elements.
       See more examples at http://garden.zendesk.com/css-bedrock/utilities/spacing/ -->
  <script src="https://cdn.jsdelivr.net/jquery/3.0.0/jquery.min.js"></script>
  <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
  <div class="u-m u-fg-dark-gray">
    <div class="u-cf u-mb">
      <a href="https://docs.google.com/spreadsheets/d/1rXXTmjSPDlHKPXcjChLh_f9so8YC-O_ad7LBTf2UBeE/edit#gid=2049647835" class="u-float-right c-btn c-btn--pill">More Info &gt;</a>
      <h2 class="u-gamma u-mb">OnShift</h2>
      <!-- Bedrock grid assumes that column elements are side-by-side, eliminating whitespace.
           Hence, tags are closed on the following line to ensure no whitespace between grid items.
           See more examples at http://garden.zendesk.com/css-bedrock/layouts/grid/ -->
      <div class="l-grid u-mb u-ta-center">
        <span class="l-grid__item u-1/2"><code class="u-bg-platinum u-display-block u-p-xs">Andrey</code></span
        ><span class="l-grid__item u-1/2"><code class="u-bg-platinum u-display-block u-p-xs">Elizabeth</code></span>
      </div>
    </div>

    <div class="u-cf u-mb">
      <a href="https://jira.odesk.com/issues/?jql=project%20%3D%20%22IM%22%20AND%20resolution%20%3D%20Unresolved%20ORDER%20BY%20priority%20DESC%2C%20updated%20DESC"
        class="u-float-right c-btn c-btn--pill">More Info &gt;</a>
      <h2 class="u-gamma u-mb">Incidents</h2>
      <div class="l-grid l-grid--xs u-ta-center">
        <span class="l-grid__item u-2/12"><code class="u-bg-orange-peel u-br-l u-display-block u-fg-white u-p-xs">IM-1516</code></span
        ><span class="l-grid__item u-9/12"><code class="u-bg-orange-peel u-display-block u-fg-white u-p-xs">WD is not frozed, weekly invoices generation process is blocked</code></span
        ><span class="l-grid__item u-1/12"><code class="u-bg-mandy u-br-r u-display-block u-fg-white u-p-xs">P0</code></span>
      </div>
    </div>
    <div class="u-cf u-mb">
      <h2 class="u-gamma u-mb">Queues</h2>
      <div class="l-grid l-grid--xs u-ta-center">
        <span class="l-grid__item u-1/8"><code class="u-bg-algae u-br-l u-display-block u-fg-white u-p-xs">Unreviewed PT<h2 class="u-gamma u-mb">115</h2></code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-apple-green u-display-block u-fg-white u-p-xs">115</code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-pelorous u-display-block u-fg-white u-p-xs">111</code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-orange-peel u-display-block u-fg-white u-p-xs">110</code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-mandy u-display-block u-fg-white u-p-xs">58</code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-mandy u-display-block u-fg-white u-p-xs">57</code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-mandy u-display-block u-fg-white u-p-xs">56</code></span
        ><span class="l-grid__item u-1/8"><code class="u-bg-mandy u-br-r u-display-block u-fg-white u-p-xs">155</code></span>
      </div>
    </div>
    <div class="u-cf u-mb">
      <!-- Bedrock grid assumes that column elements are side-by-side, eliminating whitespace.
           Hence, tags are closed on the following line to ensure no whitespace between grid items.
           See more examples at http://garden.zendesk.com/css-bedrock/layouts/grid/ -->
      <div class="l-grid--xs u-mb u-ta-center">
        <span class="l-grid__item u-1/2"><code class="u-bg-columbia-blue u-display-block u-p-xs">
          <fieldset class="u-mb-lg u-float-right" style="">
          <div class="c-txt">
            <button class="c-txt__input c-txt__input--select" id="select-0"><span dir="ltr">Member<span></span></span>
        </button>
      </div>
      <ul class="c-menu c-menu--down is-hidden" style="display: none;" aria-hidden="true">
        <li class="c-menu__item">ALL</li>
        <li class="c-menu__item is-selected"><span dir="ltr">Andrey</span></li>
        <li class="c-menu__item">Anna</li>
        <li class="c-menu__item">Dmitry D</li>
        <li class="c-menu__item">Sergey</li>
      </ul>
      </fieldset>
      <h2 class="u-gamma u-mb">Jira</h2>
      <section data-main-jira>Loading...</section>
      <div id="content"></div>
      <script id="showdata" type="text/x-handlebars-template">
        <h3><b>Recent Comments</b></h3>
        <br>
        <hr><br> {{#each problems}}
        <a href="https://jira.odesk.com/browse/{{id}}">#{{id}} - {{subject}}</a><br><br> {{description}} {{# if @last}} {{else}}
        <br>
        <hr><br> {{/if}} {{else}} No comments found. {{/each}}
      </script>
      <!--<script id="showdata" type="text/x-handlebars-template">
        <h3><b>Recent Comments</b></h3>
        <br>
        <hr><br> {{#each id}}
        <a href="https://jira.odesk.com/browse/{{id}}">#{{id}} - {{subject}}</a><br><br> {{description}} {{# if @last}} {{else}}
        <br>
        <hr><br> {{/if}} {{else}} No comments found. {{/each}}
      </script>-->
      </code>
      </span><span class="l-grid__item u-1/2"><code class="u-bg-magic-mint u-display-block u-p-xs">
          <a href="https://docs.google.com/spreadsheets/d/1rXXTmjSPDlHKPXcjChLh_f9so8YC-O_ad7LBTf2UBeE/edit#gid=2049647835" class="u-float-right c-btn c-btn--pill">Settings &gt;</a>
      <h2 class="u-gamma u-mb">Zendesk</h2>
      
      </code></span>
    </div>
  </div>
  </div>
  <script src="https://cdn.jsdelivr.net/jquery/3.0.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
  <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
  <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
  <script>
    // Initialise the Zendesk JavaScript API client
    // https://developer.zendesk.com/apps/docs/apps-v2
    var client = ZAFClient.init();

    function renderText(text) {
      var mainSectionEl = document.querySelector('section[data-main-jira]');
      mainSectionEl.innerText = text;
    }

    function getJira(url) {
      return client.request({
        //url: 'https://jira.odesk.com/rest/api/2/search?jql=issueFunction%20in%20commented(%22by%20dmitry%22)&maxResults=10',
        url: url,
        //headers: { "Authorization": "Bearer {{setting.token}}" },
        headers: { "Authorization": "Basic {{setting.token}}" },
        secure: true,
        type: 'GET',
        //cors: true,
        dataType: 'json'
      }).then(function (data) {
        //if (data.count > 1) { alert(data) }
        //return data.users[0];
        return data;
      })
    }

    function getAgora(url) {
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", url, false);
      xhttp.setRequestHeader("Authorization", "");
      xhttp.setRequestHeader("Accept", "application/json");
      xhttp.setRequestHeader("X-Agora-SwaggerUI-Request", "true");
      xhttp.send();
      var response = JSON.parse(xhttp.responseText);
      return response;
    }

    function showInfo(data) {
      var requester_data = {
        'href': data
      };
      var source = $("#bobo").html();
      var template = Handlebars.compile(source)
      var html = template(requester_data)
      $("#content").html(html);
    }

    function getCurrentUser() {
      return client.get('currentUser').then(function (data) {
        return data['currentUser'];
      });
    }

    function showData_Jira(jira_bug, jira_body, jira_created, index) {
      //var problems = response.tickets;
      var cut_length = 200;
      var jira_data = [];
      //var bug = {};
      var problems = [{ description: "", subject: "", id: "" }];
      for (var i = 0; i <= index; i++) {
        jira_body[i] = jira_body[i].length > cut_length ? jira_body[i].substring(0, cut_length - 3) + '...' : jira_body[i].substring(0, cut_length);
        jira_data[i] = jira_bug + ": " + jira_body + " (" + jira_created + ")";
        problems[i].description = jira_body[i];
        problems[i].subject = jira_created[i];
        problems[i].id = jira_bug[i];
      }

      var data = {
        'problems': problems
        //'id': jira_bug,
        //'subject': jira_created,
        //'description': jira_body,

      }
      console.log(data);
      var source = $("#showdata").html();
      console.log(source);
      var template = Handlebars.compile(source);
      console.log(template);
      var html = template(data);
      console.log(html);
      $("#content").html(html);
    }

    function init() {
      var url = 'https://jira-ext.odesk.com/rest/api/2/search?jql=issueFunction%20in%20commented(%22by%20dmitry%22)&maxResults=10';
      getJira(url).then(function (data) {
        //var oboUrl = 'https://int.upwork.com/obo';
        //var extId = data.external_id;
        //var userRole = data.role;
        //console.log(data);
        var jira_bug = [];
        var jira_body = [];
        var jira_created = [];
        var line = 0;
        for (var i = 0; i < data.maxResults; i++) {
          var issue = data.issues[i].self;
          getJira(issue).then(function (data2) {
            //console.log(data2);
            var comment = data2.fields.comment;
            var count = data2.fields.comment.total;
            for (var j = 0; j < count; j++) {
              if (comment.comments[j].author = 'dmitry') {
                jira_bug[line] = data2.key; //bug
                jira_body[line] = comment.comments[j].body; //body
                jira_created[line] = comment.comments[j].created; //created
                line++;
              }
            }
          });
        }
        //return { jira_bug, jira_body, jira_created,line };
        console.log(jira_bug);
        console.log(jira_body);
        console.log(jira_created);
        showData_Jira(jira_bug, jira_body, jira_created, line - 1);
      })
      var url = 'http://swagger-prod.console.agora.odesk.com:8618/proxy/vendorJobApplicationsFacadeDS-v.1.22.7/o/v/424142924658016256/applications?offset=0&limit=10';
      getAgora(url).then(function (dataX) { console.log(dataX); });
    }

    client.on('app.registered', function () {
      //client.invoke('resize', { width: '100%', height: '80px' });
      init();
    });
  </script>
</body>

</html>